<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk Upload - Outfit Generator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 30px; }
    .upload-area {
      background: white;
      padding: 40px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .file-input {
      margin: 20px 0;
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .file-input:hover { border-color: #000; background: #fafafa; }
    .file-input input { display: none; }
    button {
      background: #000;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      font-family: inherit;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .progress {
      margin: 20px 0;
      background: #f0f0f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: #000;
      width: 0%;
      transition: width 0.3s;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      display: none;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    .log {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.6;
    }
    .log-entry { margin: 5px 0; }
    .log-entry.success { color: #155724; }
    .log-entry.error { color: #721c24; }
    .log-entry.info { color: #0c5460; }
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 4px;
      overflow: hidden;
      background: white;
    }
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .preview-item .label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 9px;
      padding: 2px 4px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <h1>üöÄ Bulk Upload Existing Clothes</h1>
  
  <div class="upload-area">
    <p>Select all your existing clothing images to upload to Firebase.</p>
    <p style="margin-top: 10px; color: #666; font-size: 14px;">
      The script will auto-detect categories, colors, and styles from folder names and filenames.
    </p>
    
    <div class="file-input" onclick="document.getElementById('file-input').click()">
      <input type="file" id="file-input" webkitdirectory directory multiple>
      <p>üìÅ Click to select entire folder</p>
      <p style="margin-top: 10px; color: #999; font-size: 12px;">Select: /Users/aiman/Downloads/HIGH-QUALITY-NO-BG</p>
      <p id="file-count" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
    </div>
    
    <button id="upload-btn" disabled>Upload All Items</button>
    
    <div class="progress" id="progress">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    
    <div class="status" id="status"></div>
  </div>
  
  <div class="log" id="log"></div>

  <script type="module">
    import { initFirebase } from './firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { doc, getDoc, setDoc, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    let auth, db, storage, currentUser;
    let selectedFiles = [];

    // Initialize Firebase
    const { auth: fbAuth, db: fbDb, storage: fbStorage } = await initFirebase();
    auth = fbAuth;
    db = fbDb;
    storage = fbStorage;

    // Check auth
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        log(`‚úÖ Logged in as: ${user.email}`, 'success');
      } else {
        window.location.href = 'auth.html';
      }
    });

    // File input handler
    const fileInput = document.getElementById('file-input');
    const fileCount = document.getElementById('file-count');
    const uploadBtn = document.getElementById('upload-btn');

    fileInput.addEventListener('change', (e) => {
      const allFiles = Array.from(e.target.files);
      
      // Filter out non-clothing items (accessories, etc.)
      selectedFiles = allFiles.filter(file => {
        const path = (file.webkitRelativePath || file.name).toLowerCase();
        const filename = file.name.toLowerCase();
        
        // Skip EDC/accessories folders
        if (path.includes('/edc/') || path.includes('/accessories/')) return false;
        
        // Skip generated/temp files
        if (filename.includes('generative fill') || filename.includes('generated image')) return false;
        
        // Only include image files
        if (!file.type.startsWith('image/')) return false;
        
        return true;
      });
      
      fileCount.textContent = `${selectedFiles.length} clothing items selected (${allFiles.length} total files)`;
      uploadBtn.disabled = selectedFiles.length === 0;
      log(`üìÅ Selected ${selectedFiles.length} clothing items from ${allFiles.length} total files`, 'info');
      
      // Show folder structure summary
      const categories = {};
      selectedFiles.forEach(file => {
        const info = parseItemInfo(file);
        categories[info.category] = (categories[info.category] || 0) + 1;
      });
      log(`üìä Breakdown: ${Object.entries(categories).map(([cat, count]) => `${cat}: ${count}`).join(', ')}`, 'info');
    });

    // Parse item info from file path
    function parseItemInfo(file) {
      const path = file.webkitRelativePath || file.name;
      const filename = file.name.toLowerCase();
      const pathLower = path.toLowerCase();
      
      // Determine category from path or filename
      let category = 'top';
      let topLayer = null;
      
      // Check folder structure (works for both old assets/ and new HIGH-QUALITY-NO-BG/)
      if (pathLower.includes('/tees/') || pathLower.includes('/t-shirt/') || filename.includes('-tee')) {
        category = 'top';
        topLayer = 'base';
      } else if (pathLower.includes('/midlayer/') || pathLower.includes('/overshirts/') || pathLower.includes('/long-sleeve/') || 
                 filename.includes('button-up') || filename.includes('hoodie') || filename.includes('crewneck')) {
        category = 'top';
        topLayer = 'overshirt';
      } else if (pathLower.includes('/jackets/') || pathLower.includes('/outerwear/') ||
                 filename.includes('jacket') || filename.includes('parka') || filename.includes('montone')) {
        category = 'jacket';
      } else if (pathLower.includes('/pants/') || pathLower.includes('/trousers/') || pathLower.includes('/bottoms/')) {
        category = 'pants';
      } else if (pathLower.includes('/shoes/') || pathLower.includes('/footwear/') || pathLower.includes('/sneakers/') ||
                 filename.includes('samba') || filename.includes('boots') || filename.includes('goose') || 
                 filename.includes('balance') || filename.includes('salomon') || filename.includes('mocassino')) {
        category = 'shoes';
      }
      
      // Extract colors
      const colors = [];
      const colorMap = {
        'black': 'black', 'white': 'white', 'navy': 'navy',
        'grey': 'grey', 'gray': 'grey', 'beige': 'beige',
        'brown': 'brown', 'green': 'green', 'blue': 'blue',
        'red': 'red', 'military': 'green', 'bordeaux': 'red',
        'khaki': 'beige'
      };
      
      for (const [key, value] of Object.entries(colorMap)) {
        if (filename.includes(key) && !colors.includes(value)) {
          colors.push(value);
        }
      }
      
      // Extract styles
      const styles = [];
      if (filename.includes('polo') || filename.includes('button')) {
        styles.push('casual');
      }
      if (filename.includes('sport') || filename.includes('nike') || filename.includes('adidas')) {
        styles.push('sport');
      }
      if (filename.includes('street') || filename.includes('hoodie')) {
        styles.push('street');
      }
      if (!styles.length) styles.push('casual');
      
      // Generate name
      const name = file.name.replace(/\.(png|jpg|jpeg)$/i, '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      return { category, topLayer, colors, styles, name };
    }

    // Compress image
    async function compressImage(file, maxWidth = 1200) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/jpeg' }));
            }, 'image/jpeg', 0.85);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Upload single item
    async function uploadItem(file, index, total) {
      const info = parseItemInfo(file);
      log(`[${index + 1}/${total}] Processing: ${info.name} (${info.category})`, 'info');
      
      try {
        // Compress
        log(`  ‚Üí Compressing...`, 'info');
        const compressed = await compressImage(file);
        log(`  ‚Üí Compressed: ${(file.size / 1024).toFixed(0)}KB ‚Üí ${(compressed.size / 1024).toFixed(0)}KB`, 'info');
        
        // Upload to Storage
        log(`  ‚Üí Uploading to Firebase Storage...`, 'info');
        const fileName = `${currentUser.uid}/${Date.now()}_${index}.jpg`;
        const storageRef = ref(storage, `clothes/${fileName}`);
        await uploadBytes(storageRef, compressed);
        const downloadURL = await getDownloadURL(storageRef);
        log(`  ‚Üí Storage URL obtained`, 'info');
        
        // Create item object
        const item = {
          id: `${Date.now()}_${index}`,
          name: info.name,
          category: info.category,
          topLayer: info.topLayer,
          file: downloadURL,
          storagePath: fileName,
          colorHints: info.colors,
          styleHints: info.styles,
          uploadedAt: new Date().toISOString()
        };
        
        // Add to Firestore (use setDoc with merge to handle existing/non-existing docs)
        log(`  ‚Üí Saving to Firestore...`, 'info');
        const userRef = doc(db, 'users', currentUser.uid);
        
        // Get current user doc
        const userDoc = await getDoc(userRef);
        const currentItems = userDoc.exists() && userDoc.data().items ? userDoc.data().items : [];
        
        // Add new item
        await setDoc(userRef, {
          items: [...currentItems, item]
        }, { merge: true });
        
        log(`‚úÖ [${index + 1}/${total}] Uploaded: ${info.name}`, 'success');
        return { success: true, item: info.name };
      } catch (error) {
        console.error('Upload error:', error);
        log(`‚ùå [${index + 1}/${total}] Failed: ${info.name} - ${error.message}`, 'error');
        return { success: false, item: info.name, error: error.message };
      }
    }

    // Bulk upload
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFiles.length || !currentUser) return;
      
      uploadBtn.disabled = true;
      const progressEl = document.getElementById('progress');
      const progressBar = document.getElementById('progress-bar');
      const statusEl = document.getElementById('status');
      
      progressEl.style.display = 'block';
      statusEl.style.display = 'block';
      statusEl.className = 'status info';
      statusEl.textContent = 'Starting bulk upload...';
      
      log(`üöÄ Starting upload of ${selectedFiles.length} items...`, 'info');
      log(`üë§ User: ${currentUser.email} (${currentUser.uid})`, 'info');
      
      const results = [];
      
      for (let i = 0; i < selectedFiles.length; i++) {
        const result = await uploadItem(selectedFiles[i], i, selectedFiles.length);
        results.push(result);
        
        // Update progress
        const progress = ((i + 1) / selectedFiles.length) * 100;
        progressBar.style.width = `${progress}%`;
        statusEl.textContent = `Uploading: ${i + 1}/${selectedFiles.length}`;
        
        // Small delay to avoid overwhelming Firebase
        if (i < selectedFiles.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 300));
        }
      }
      
      // Summary
      const successful = results.filter(r => r.success).length;
      const failed = results.filter(r => !r.success).length;
      
      if (failed === 0) {
        statusEl.className = 'status success';
        statusEl.textContent = `‚úÖ All ${successful} items uploaded successfully!`;
        log(`\nüéâ COMPLETE! ${successful} items uploaded successfully!`, 'success');
      } else {
        statusEl.className = 'status error';
        statusEl.textContent = `‚ö†Ô∏è Uploaded ${successful} items, ${failed} failed`;
        log(`\n‚ö†Ô∏è COMPLETE! ${successful} succeeded, ${failed} failed`, 'error');
      }
      
      uploadBtn.disabled = false;
      
      setTimeout(() => {
        if (failed === 0) {
          window.location.href = 'upload.html';
        }
      }, 3000);
    });

    // Log function
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }
  </script>
</body>
</html>

