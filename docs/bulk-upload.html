<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bulk upload</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font: 11px/1.4 'Monaco', 'Menlo', 'Consolas', monospace;
      background: #fff;
      color: #000;
      letter-spacing: 0.3px;
      padding: 40px 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      font-size: 14px;
      font-weight: normal;
      margin-bottom: 30px;
      text-align: center;
    }
      .upload-area {
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 20px;
      }
      p { margin-bottom: 12px; color: #666; }
      .file-input {
        margin: 20px 0;
        padding: 30px;
        border: 1px dashed #ccc;
        text-align: center;
        cursor: pointer;
      }
      .file-input:hover { 
        background: #f5f5f5;
        border-color: #999;
      }
    .file-input input { display: none; }
    button {
      padding: 10px 16px;
      background: #000;
      color: #fff;
      border: none;
      font: inherit;
      cursor: pointer;
    }
    button:hover { background: #333; }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .progress {
      margin: 16px 0;
      background: #f0f0f0;
      height: 2px;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: #000;
      width: 0%;
      transition: width 0.3s;
    }
      .status {
        margin-top: 16px;
        padding: 10px;
        border: 1px solid #ddd;
        display: none;
      }
      .status.success { background: #efe; }
      .status.error { background: #fee; }
      .status.info { background: #eff; }
      .log {
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 16px;
        max-height: 400px;
        overflow-y: auto;
        font-size: 10px;
        line-height: 1.5;
      }
    .log-entry { margin: 4px 0; }
    .log-entry.success { color: #070; }
    .log-entry.error { color: #c00; }
    .log-entry.info { color: #666; }
  </style>
</head>
<body>
  <h1>[bulk upload]</h1>
  
  <div class="upload-area">
    <p>select your entire clothing folder to upload all items at once</p>
    <p style="color: #999;">automatically filters accessories and detects categories from folder structure</p>
    <p style="color: #999; font-size: 10px; margin-top: 8px;">recommended: select /Users/aiman/Downloads/HIGH-QUALITY-NO-BG</p>
    
    <div class="file-input" onclick="document.getElementById('file-input').click()">
      <input type="file" id="file-input" webkitdirectory directory multiple>
      <p>[click to select folder]</p>
      <p id="file-count" style="margin-top: 10px; color: #666;"></p>
    </div>
    
    <button id="upload-btn" disabled>[upload all items]</button>
    
    <div class="progress" id="progress">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    
    <div class="status" id="status"></div>
  </div>
  
  <div class="log" id="log"></div>

  <script type="module">
    import { initFirebase } from './firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    let auth, db, storage, currentUser;
    let selectedFiles = [];

    // Initialize Firebase
    const { auth: fbAuth, db: fbDb, storage: fbStorage } = await initFirebase();
    auth = fbAuth;
    db = fbDb;
    storage = fbStorage;

    // Check auth
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        log(`logged in: ${user.email}`, 'success');
      } else {
        window.location.href = 'auth.html';
      }
    });

    // File input handler
    const fileInput = document.getElementById('file-input');
    const fileCount = document.getElementById('file-count');
    const uploadBtn = document.getElementById('upload-btn');

    fileInput.addEventListener('change', (e) => {
      const allFiles = Array.from(e.target.files);
      
      selectedFiles = allFiles.filter(file => {
        const path = (file.webkitRelativePath || file.name).toLowerCase();
        const filename = file.name.toLowerCase();
        
        if (path.includes('/edc/') || path.includes('/accessories/')) return false;
        if (filename.includes('generative fill') || filename.includes('generated image')) return false;
        if (!file.type.startsWith('image/')) return false;
        
        return true;
      });
      
      fileCount.textContent = `${selectedFiles.length} items selected (${allFiles.length} total files)`;
      uploadBtn.disabled = selectedFiles.length === 0;
      log(`selected ${selectedFiles.length} items from ${allFiles.length} files`, 'info');
      
      const categories = {};
      selectedFiles.forEach(file => {
        const info = parseItemInfo(file);
        categories[info.category] = (categories[info.category] || 0) + 1;
      });
      log(`breakdown: ${Object.entries(categories).map(([cat, count]) => `${cat}: ${count}`).join(', ')}`, 'info');
    });

    // Parse item info from file path
    function parseItemInfo(file) {
      const path = file.webkitRelativePath || file.name;
      const filename = file.name.toLowerCase();
      const pathLower = path.toLowerCase();
      
      let category = 'top';
      let topLayer = null;
      
      if (pathLower.includes('/tees/') || pathLower.includes('/t-shirt/') || filename.includes('-tee')) {
        category = 'top';
        topLayer = 'base';
      } else if (pathLower.includes('/midlayer/') || pathLower.includes('/overshirts/') || pathLower.includes('/long-sleeve/') || 
                 filename.includes('button-up') || filename.includes('hoodie') || filename.includes('crewneck')) {
        category = 'top';
        topLayer = 'overshirt';
      } else if (pathLower.includes('/jackets/') || pathLower.includes('/outerwear/') ||
                 filename.includes('jacket') || filename.includes('parka') || filename.includes('montone')) {
        category = 'jacket';
      } else if (pathLower.includes('/pants/') || pathLower.includes('/trousers/') || pathLower.includes('/bottoms/')) {
        category = 'pants';
      } else if (pathLower.includes('/shoes/') || pathLower.includes('/footwear/') || pathLower.includes('/sneakers/') ||
                 filename.includes('samba') || filename.includes('boots') || filename.includes('goose') || 
                 filename.includes('balance') || filename.includes('salomon') || filename.includes('mocassino')) {
        category = 'shoes';
      }
      
      const colors = [];
      const colorMap = {
        'black': 'black', 'white': 'white', 'navy': 'navy',
        'grey': 'grey', 'gray': 'grey', 'beige': 'beige',
        'brown': 'brown', 'green': 'green', 'blue': 'blue',
        'red': 'red', 'military': 'green', 'bordeaux': 'red',
        'khaki': 'beige'
      };
      
      for (const [key, value] of Object.entries(colorMap)) {
        if (filename.includes(key) && !colors.includes(value)) {
          colors.push(value);
        }
      }
      
      const styles = [];
      if (filename.includes('polo') || filename.includes('button')) {
        styles.push('casual');
      }
      if (filename.includes('sport') || filename.includes('nike') || filename.includes('adidas')) {
        styles.push('sport');
      }
      if (filename.includes('street') || filename.includes('hoodie')) {
        styles.push('street');
      }
      if (!styles.length) styles.push('casual');
      
      const name = file.name.replace(/\.(png|jpg|jpeg)$/i, '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      return { category, topLayer, colors, styles, name };
    }

    // Compress image
    async function compressImage(file, maxWidth = 1200) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Preserve PNG format for transparent backgrounds
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/png' }));
            }, 'image/png');
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Upload single item
    async function uploadItem(file, index, total) {
      const info = parseItemInfo(file);
      log(`[${index + 1}/${total}] ${info.name} (${info.category})`, 'info');
      
      try {
        log(`  compressing...`, 'info');
        const compressed = await compressImage(file);
        
        log(`  uploading...`, 'info');
        const fileName = `${currentUser.uid}/${Date.now()}_${index}.png`;
        const storageRef = ref(storage, `clothes/${fileName}`);
        await uploadBytes(storageRef, compressed);
        const downloadURL = await getDownloadURL(storageRef);
        
        log(`  saving...`, 'info');
        const item = {
          id: `${Date.now()}_${index}`,
          name: info.name,
          category: info.category,
          topLayer: info.topLayer,
          file: downloadURL,
          storagePath: fileName,
          colorHints: info.colors,
          styleHints: info.styles,
          uploadedAt: new Date().toISOString()
        };
        
        const userRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userRef);
        const currentItems = userDoc.exists() && userDoc.data().items ? userDoc.data().items : [];
        
        await setDoc(userRef, {
          items: [...currentItems, item]
        }, { merge: true });
        
        log(`✓ [${index + 1}/${total}] ${info.name}`, 'success');
        return { success: true, item: info.name };
      } catch (error) {
        console.error('Upload error:', error);
        log(`✗ [${index + 1}/${total}] ${info.name} - ${error.message}`, 'error');
        return { success: false, item: info.name, error: error.message };
      }
    }

    // Bulk upload
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFiles.length || !currentUser) return;
      
      uploadBtn.disabled = true;
      const progressEl = document.getElementById('progress');
      const progressBar = document.getElementById('progress-bar');
      const statusEl = document.getElementById('status');
      
      progressEl.style.display = 'block';
      statusEl.style.display = 'block';
      statusEl.className = 'status info';
      statusEl.textContent = 'starting bulk upload...';
      
      log(`starting upload of ${selectedFiles.length} items...`, 'info');
      log(`user: ${currentUser.email} (${currentUser.uid})`, 'info');
      
      const results = [];
      
      for (let i = 0; i < selectedFiles.length; i++) {
        const result = await uploadItem(selectedFiles[i], i, selectedFiles.length);
        results.push(result);
        
        const progress = ((i + 1) / selectedFiles.length) * 100;
        progressBar.style.width = `${progress}%`;
        statusEl.textContent = `uploading: ${i + 1}/${selectedFiles.length}`;
        
        if (i < selectedFiles.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 300));
        }
      }
      
      const successful = results.filter(r => r.success).length;
      const failed = results.filter(r => !r.success).length;
      
      if (failed === 0) {
        statusEl.className = 'status success';
        statusEl.textContent = `complete! ${successful} items uploaded`;
        log(`\ncomplete! ${successful} items uploaded`, 'success');
      } else {
        statusEl.className = 'status error';
        statusEl.textContent = `uploaded ${successful}, failed ${failed}`;
        log(`\nfinished: ${successful} succeeded, ${failed} failed`, 'error');
      }
      
      uploadBtn.disabled = false;
      
      setTimeout(() => {
        if (failed === 0) {
          window.location.href = 'upload.html';
        }
      }, 3000);
    });

    // Log function
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }
  </script>
</body>
</html>
