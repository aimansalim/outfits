<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>auth</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font: 11px/1.4 'Monaco', 'Menlo', 'Consolas', monospace;
        background: #fff;
        color: #000;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        width: 100%;
        max-width: 360px;
        border: 1px solid #000;
        padding: 30px;
      }
      h1 {
        font-size: 14px;
        font-weight: normal;
        margin-bottom: 20px;
        text-align: center;
      }
      .form-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 4px;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #000;
        font: inherit;
        background: #fff;
      }
      input:focus {
        outline: none;
        background: #f5f5f5;
      }
      button {
        width: 100%;
        padding: 10px;
        background: #000;
        color: #fff;
        border: none;
        font: inherit;
        cursor: pointer;
        margin-top: 8px;
      }
      button:hover {
        background: #333;
      }
      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .toggle {
        text-align: center;
        margin-top: 20px;
      }
      .toggle a {
        color: #000;
        cursor: pointer;
      }
      .error, .success {
        padding: 10px;
        margin-bottom: 16px;
        border: 1px solid #000;
        display: none;
      }
      .error {
        background: #fee;
      }
      .success {
        background: #efe;
      }
      .username-group {
        display: none;
      }
      .signup .username-group {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="title">[login]</h1>
      
      <div class="error" id="error"></div>
      <div class="success" id="success"></div>
      
      <form id="auth-form">
        <div class="form-group username-group">
          <label>username</label>
          <input type="text" id="username" autocomplete="username" />
        </div>
        
        <div class="form-group">
          <label>email</label>
          <input type="email" id="email" required autocomplete="email" />
        </div>
        
        <div class="form-group">
          <label>password</label>
          <input type="password" id="password" required autocomplete="current-password" />
        </div>
        
        <button type="submit" id="submit-btn">[login]</button>
      </form>
      
      <div class="toggle">
        <a id="toggle-mode">[create account]</a>
      </div>
    </div>

    <script type="module">
      import { initFirebase } from './firebase-config.js';
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

      let auth, db;
      let isSignUp = false;

      const container = document.querySelector('.container');
      const title = document.getElementById('title');
      const form = document.getElementById('auth-form');
      const usernameInput = document.getElementById('username');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const submitBtn = document.getElementById('submit-btn');
      const toggleMode = document.getElementById('toggle-mode');
      const errorDiv = document.getElementById('error');
      const successDiv = document.getElementById('success');

      // Initialize Firebase
      (async () => {
        const firebase = await initFirebase();
        auth = getAuth(firebase.app);
        db = getFirestore(firebase.app);
        
        // Redirect if already logged in
        onAuthStateChanged(auth, (user) => {
          if (user) {
            window.location.href = 'index.html';
          }
        });
      })();

      // Toggle between login and signup
      toggleMode.addEventListener('click', () => {
        isSignUp = !isSignUp;
        if (isSignUp) {
          container.classList.add('signup');
          title.textContent = '[create account]';
          submitBtn.textContent = '[sign up]';
          toggleMode.textContent = '[login instead]';
          usernameInput.required = true;
        } else {
          container.classList.remove('signup');
          title.textContent = '[login]';
          submitBtn.textContent = '[login]';
          toggleMode.textContent = '[create account]';
          usernameInput.required = false;
        }
        hideMessages();
      });

      function showError(msg) {
        errorDiv.textContent = msg;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
      }

      function showSuccess(msg) {
        successDiv.textContent = msg;
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
      }

      function hideMessages() {
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
      }

      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessages();
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const username = usernameInput.value.trim();
        
        if (isSignUp && !username) {
          showError('username required');
          return;
        }
        
        if (password.length < 6) {
          showError('password must be at least 6 characters');
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = isSignUp ? '[creating...]' : '[logging in...]';
        
        try {
          if (isSignUp) {
            // Check username uniqueness
            const usernameDoc = await getDoc(doc(db, 'usernames', username.toLowerCase()));
            if (usernameDoc.exists()) {
              showError('username already taken');
              submitBtn.disabled = false;
              submitBtn.textContent = '[sign up]';
              return;
            }
            
            // Create account
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName: username });
            
            // Save username mapping and user doc
            await setDoc(doc(db, 'usernames', username.toLowerCase()), { uid: userCredential.user.uid });
            await setDoc(doc(db, 'users', userCredential.user.uid), {
              username: username,
              createdAt: new Date(),
              items: []
            });
            
            showSuccess('account created! redirecting...');
            setTimeout(() => {
              window.location.href = 'upload.html';
            }, 1500);
          } else {
            // Login
            await signInWithEmailAndPassword(auth, email, password);
            showSuccess('login successful! redirecting...');
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 1000);
          }
        } catch (error) {
          console.error('Auth error:', error);
          let message = error.message;
          
          if (error.code === 'auth/email-already-in-use') {
            message = 'email already in use';
          } else if (error.code === 'auth/invalid-email') {
            message = 'invalid email';
          } else if (error.code === 'auth/user-not-found') {
            message = 'user not found';
          } else if (error.code === 'auth/wrong-password') {
            message = 'wrong password';
          } else if (error.code === 'auth/too-many-requests') {
            message = 'too many attempts. try again later';
          }
          
          showError(message);
          submitBtn.disabled = false;
          submitBtn.textContent = isSignUp ? '[sign up]' : '[login]';
        }
      });
    </script>
  </body>
</html>
