<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>wardrobe</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font: 11px/1.4 'Monaco', 'Menlo', 'Consolas', monospace;
        background: #fff;
        color: #000;
        letter-spacing: 0.3px;
      }
      
      /* Top menu */
      .menu {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 1000;
      }
      .menu-btn {
        background: #fff;
        border: 1px solid #ddd;
        padding: 6px 10px;
        font: inherit;
        cursor: pointer;
        color: #000;
      }
      .menu-btn:hover { 
        background: #f8f8f8;
        border-color: #999;
      }
      .menu-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 2px;
        background: #fff;
        border: 1px solid #ddd;
        min-width: 180px;
      }
      .menu-dropdown.open { display: block; }
      .menu-dropdown a, .menu-dropdown button, .menu-dropdown div {
        display: block;
        width: 100%;
        padding: 10px 14px;
        background: none;
        border: none;
        border-bottom: 1px solid #f0f0f0;
        font: inherit;
        text-align: left;
        text-decoration: none;
        color: #000;
        cursor: pointer;
      }
      .menu-dropdown div {
        color: #666;
        font-weight: 500;
        cursor: default;
      }
      .menu-dropdown div:hover { background: #fff; }
      .menu-dropdown a:last-child, .menu-dropdown button:last-child { border-bottom: none; }
      .menu-dropdown a:hover, .menu-dropdown button:hover { background: #f8f8f8; }
      
      /* Container */
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 60px 20px 20px;
      }
      h1 {
        font-size: 14px;
        font-weight: normal;
        margin-bottom: 30px;
        text-align: center;
      }
      
      /* Upload area */
      .upload-section {
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 40px;
      }
      .upload-area {
        border: 1px dashed #ccc;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .upload-area:hover { 
        background: #f5f5f5;
        border-color: #999;
      }
      input[type="file"] { display: none; }
      
      .preview {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .preview img {
        max-width: 200px;
        max-height: 200px;
        border: 1px solid #ddd;
      }
      
      /* Form */
      .form-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 4px;
      }
      input, select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        font: inherit;
        background: #fff;
      }
      input:focus, select:focus {
        outline: none;
        border-color: #999;
        background: #fafafa;
      }
      
      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
      }
      .checkbox-group label {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .checkbox-group input {
        width: auto;
        margin-right: 4px;
      }
      
      button {
        padding: 10px 16px;
        background: #000;
        color: #fff;
        border: none;
        font: inherit;
        cursor: pointer;
      }
      button:hover {
        background: #333;
      }
      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      
      /* Progress */
      .progress {
        margin-top: 16px;
        background: #f0f0f0;
        height: 2px;
        display: none;
      }
      .progress-bar {
        height: 100%;
        background: #000;
        width: 0%;
        transition: width 0.3s;
      }
      .upload-status {
        margin-top: 8px;
        display: none;
        text-align: center;
      }
      
      /* Items list */
      .items-list {
        margin-top: 40px;
      }
      .items-list h2 {
        font-size: 12px;
        font-weight: normal;
        margin-bottom: 20px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 24px;
      }
      .item-card {
        position: relative;
      }
      .item-card .img-wrap {
        width: 100%;
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden;
        border: 1px solid #f0f0f0;
      }
      .item-card img {
        max-width: 90%;
        max-height: 90%;
        width: auto;
        height: auto;
        object-fit: contain;
      }
      .item-card .delete-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        background: rgba(255,255,255,0.95);
        border: 1px solid #e0e0e0;
        width: 24px;
        height: 24px;
        font-size: 14px;
        line-height: 1;
        cursor: pointer;
        color: #999;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 2px;
      }
      .item-card .delete-btn:hover {
        background: #fff;
        color: #c00;
        border-color: #c00;
      }
      .item-card .info {
        font-size: 10px;
        color: #666;
        text-align: center;
        line-height: 1.4;
        height: 28px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
    </style>
  </head>
  <body>
    <!-- Menu -->
    <div class="menu">
      <button class="menu-btn" id="menu-toggle">[≡]</button>
      <div class="menu-dropdown" id="menu-dropdown">
        <div style="padding: 8px 12px; color: #666; border-bottom: 1px solid #eee;" id="menu-user">@loading...</div>
        <a href="index.html">[generator]</a>
        <button id="share-btn">[share closet]</button>
        <button id="menu-logout">[logout]</button>
      </div>
    </div>
    
    <div class="container">
      <h1>[wardrobe]</h1>
      
      <!-- Upload section -->
      <div class="upload-section">
        <div class="upload-area" id="upload-area">
          <input type="file" id="file-input" accept="image/*" />
          <p>[click to upload image]</p>
        </div>
        
        <div class="preview" id="preview">
          <img id="preview-img" alt="Preview" />
        </div>
        
        <div class="form-group">
          <label>name (optional)</label>
          <input type="text" id="item-name" placeholder="e.g. black tee" />
        </div>
        
        <div class="form-group">
          <label>category</label>
          <select id="category">
            <option value="">select...</option>
            <option value="top">tee / base layer</option>
            <option value="top-overshirt">overshirt / midlayer</option>
            <option value="jacket">jacket</option>
            <option value="pants">pants</option>
            <option value="shoes">shoes</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>colors</label>
          <div class="checkbox-group">
            <label><input type="checkbox" value="black" /> black</label>
            <label><input type="checkbox" value="white" /> white</label>
            <label><input type="checkbox" value="navy" /> navy</label>
            <label><input type="checkbox" value="grey" /> grey</label>
            <label><input type="checkbox" value="beige" /> beige</label>
            <label><input type="checkbox" value="brown" /> brown</label>
            <label><input type="checkbox" value="green" /> green</label>
            <label><input type="checkbox" value="blue" /> blue</label>
            <label><input type="checkbox" value="red" /> red</label>
          </div>
        </div>
        
        <div class="form-group">
          <label>styles</label>
          <div class="checkbox-group">
            <label><input type="checkbox" value="casual" /> casual</label>
            <label><input type="checkbox" value="formal" /> formal</label>
            <label><input type="checkbox" value="street" /> street</label>
            <label><input type="checkbox" value="sport" /> sport</label>
          </div>
        </div>
        
        <button id="upload-btn" disabled>[upload item]</button>
        
        <div class="progress" id="progress">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="upload-status" id="upload-status"></div>
      </div>
      
      <!-- Items list -->
      <div class="items-list">
        <h2>[your items] <span id="item-count">0</span></h2>
        <div class="loading" id="loading">loading...</div>
        <div class="items-grid" id="items-grid"></div>
      </div>
    </div>

    <script type="module">
      import { initFirebase } from './firebase-config.js';
      import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      import { getFirestore, doc, getDoc, setDoc, deleteField } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

      let auth, db, storage, currentUser;
      let selectedFile = null;

      // Initialize Firebase
      const firebase = await initFirebase();
      auth = getAuth(firebase.app);
      db = getFirestore(firebase.app);
      storage = getStorage(firebase.app);

      // Check auth
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          const displayName = user.displayName || user.email.split('@')[0];
          document.getElementById('menu-user').textContent = `@${displayName}`;
          loadUserItems();
        } else {
          window.location.href = 'auth.html';
        }
      });

      // Menu toggle
      const menuToggle = document.getElementById('menu-toggle');
      const menuDropdown = document.getElementById('menu-dropdown');
      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle('open');
      });
      document.addEventListener('click', () => {
        menuDropdown.classList.remove('open');
      });

      // Logout
      document.getElementById('menu-logout').addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'auth.html';
      });

      // Share closet
      document.getElementById('share-btn').addEventListener('click', () => {
        if (!currentUser || !currentUser.displayName) return;
        const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
        const shareUrl = `${window.location.origin}${basePath}/index.html?user=${currentUser.displayName}`;
        
        if (navigator.clipboard) {
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert(`link copied:\n${shareUrl}`);
          }).catch(() => {
            prompt('share this link:', shareUrl);
          });
        } else {
          prompt('share this link:', shareUrl);
        }
      });

      // File input handling
      const fileInput = document.getElementById('file-input');
      const uploadArea = document.getElementById('upload-area');
      const preview = document.getElementById('preview');
      const previewImg = document.getElementById('preview-img');
      const uploadBtn = document.getElementById('upload-btn');

      uploadArea.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          selectedFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            uploadBtn.disabled = false;
          };
          reader.readAsDataURL(file);
        }
      });

      // Compress image
      async function compressImage(file, maxWidth = 1200) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                resolve(new File([blob], file.name, { type: 'image/jpeg' }));
              }, 'image/jpeg', 0.85);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      // Upload item
      uploadBtn.addEventListener('click', async () => {
        if (!selectedFile || !currentUser) return;
        
        const name = document.getElementById('item-name').value || selectedFile.name;
        const category = document.getElementById('category').value;
        
        if (!category) {
          alert('please select a category');
          return;
        }
        
        const colors = Array.from(document.querySelectorAll('input[type="checkbox"][value]:checked'))
          .filter(cb => ['black', 'white', 'navy', 'grey', 'beige', 'brown', 'green', 'blue', 'red'].includes(cb.value))
          .map(cb => cb.value);
        
        const styles = Array.from(document.querySelectorAll('input[type="checkbox"][value]:checked'))
          .filter(cb => ['casual', 'formal', 'street', 'sport'].includes(cb.value))
          .map(cb => cb.value);
        
        uploadBtn.disabled = true;
        uploadBtn.textContent = '[processing...]';
        
        const progressEl = document.getElementById('progress');
        const progressBar = document.getElementById('progress-bar');
        const statusEl = document.getElementById('upload-status');
        
        progressEl.style.display = 'block';
        statusEl.style.display = 'block';
        
        try {
          statusEl.textContent = 'compressing...';
          progressBar.style.width = '25%';
          const compressed = await compressImage(selectedFile);
          
          statusEl.textContent = 'uploading...';
          progressBar.style.width = '50%';
          const fileName = `${currentUser.uid}/${Date.now()}.jpg`;
          const storageRef = ref(storage, `clothes/${fileName}`);
          await uploadBytes(storageRef, compressed);
          
          statusEl.textContent = 'saving...';
          progressBar.style.width = '75%';
          const downloadURL = await getDownloadURL(storageRef);
          
          const item = {
            id: Date.now().toString(),
            name: name,
            category: category === 'top' ? 'top' : category === 'top-overshirt' ? 'top' : category,
            topLayer: category === 'top' ? 'base' : category === 'top-overshirt' ? 'overshirt' : null,
            file: downloadURL,
            storagePath: fileName,
            colorHints: colors,
            styleHints: styles,
            uploadedAt: new Date().toISOString()
          };
          
          const userRef = doc(db, 'users', currentUser.uid);
          const userDoc = await getDoc(userRef);
          const currentItems = userDoc.exists() && userDoc.data().items ? userDoc.data().items : [];
          
          await setDoc(userRef, { items: [...currentItems, item] }, { merge: true });
          
          statusEl.textContent = 'complete!';
          progressBar.style.width = '100%';
          
          setTimeout(() => {
            progressEl.style.display = 'none';
            statusEl.style.display = 'none';
            progressBar.style.width = '0%';
          }, 1500);
          
          // Reset form
          selectedFile = null;
          fileInput.value = '';
          preview.style.display = 'none';
          document.getElementById('item-name').value = '';
          document.getElementById('category').value = '';
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          uploadBtn.textContent = '[upload item]';
          uploadBtn.disabled = true;
          
          await loadUserItems();
        } catch (error) {
          console.error('Upload error:', error);
          statusEl.textContent = 'failed!';
          statusEl.style.color = '#c00';
          alert('upload failed: ' + error.message);
          uploadBtn.disabled = false;
          uploadBtn.textContent = '[upload item]';
          
          setTimeout(() => {
            progressEl.style.display = 'none';
            statusEl.style.display = 'none';
            statusEl.style.color = '#000';
            progressBar.style.width = '0%';
          }, 2000);
        }
      });

      // Load user items
      async function loadUserItems() {
        const loading = document.getElementById('loading');
        const grid = document.getElementById('items-grid');
        const count = document.getElementById('item-count');
        
        loading.style.display = 'block';
        grid.innerHTML = '';
        
        try {
          const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
          if (userDoc.exists()) {
            const items = userDoc.data().items || [];
            count.textContent = items.length;
            
            if (items.length === 0) {
              loading.textContent = 'no items yet. upload your first piece!';
              return;
            }
            
            loading.style.display = 'none';
            
            items.reverse().forEach(item => {
              const card = document.createElement('div');
              card.className = 'item-card';
              
              const colors = item.colorHints?.join(', ') || '';
              const styles = item.styleHints?.join(', ') || '';
              const topLayer = item.topLayer ? ` (${item.topLayer})` : '';
              
              card.innerHTML = `
                <div class="img-wrap">
                  <img src="${item.file}" alt="${item.name}" />
                  <button class="delete-btn" onclick="deleteItem('${item.id}', '${item.storagePath}')">×</button>
                </div>
                <div class="info">${item.name} · ${item.category}${topLayer}</div>
              `;
              
              grid.appendChild(card);
            });
          }
        } catch (error) {
          console.error('Load error:', error);
          loading.textContent = 'failed to load items';
        }
      }

      // Delete item
      window.deleteItem = async function(itemId, storagePath) {
        if (!confirm('delete this item?')) return;
        
        try {
          // Delete from storage
          const storageRef = ref(storage, `clothes/${storagePath}`);
          await deleteObject(storageRef);
          
          // Delete from firestore
          const userRef = doc(db, 'users', currentUser.uid);
          const userDoc = await getDoc(userRef);
          const items = userDoc.data().items || [];
          const updatedItems = items.filter(item => item.id !== itemId);
          
          await setDoc(userRef, { items: updatedItems }, { merge: true });
          
          await loadUserItems();
        } catch (error) {
          console.error('Delete error:', error);
          alert('failed to delete: ' + error.message);
        }
      };
    </script>
  </body>
</html>
