<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Upload Clothes - Outfit Generator</title>
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: #fff;
        color: #000;
      }
      header {
        padding: 16px 20px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        font-size: 18px;
        font-weight: 600;
      }
      header .user-info {
        font-size: 12px;
        color: #666;
      }
      header button {
        background: #fff;
        border: 1px solid #ddd;
        padding: 8px 16px;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 12px;
      }
      header button:hover {
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }
      .upload-area {
        border: 2px dashed #ddd;
        padding: 60px 20px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.2s;
      }
      .upload-area:hover {
        border-color: #000;
        background: #f5f5f5;
      }
      .upload-area.dragover {
        border-color: #000;
        background: #f0f0f0;
      }
      .upload-area h2 {
        font-size: 18px;
        margin-bottom: 8px;
      }
      .upload-area p {
        font-size: 14px;
        color: #666;
      }
      input[type="file"] {
        display: none;
      }
      .form-group {
        margin: 20px 0;
      }
      label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      select, input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        font-family: inherit;
        font-size: 14px;
      }
      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .checkbox-group label {
        display: flex;
        align-items: center;
        text-transform: none;
        font-weight: normal;
        cursor: pointer;
      }
      .checkbox-group input[type="checkbox"] {
        margin-right: 6px;
      }
      button.primary {
        background: #000;
        color: #fff;
        border: none;
        padding: 12px 24px;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
      }
      button.primary:hover {
        opacity: 0.8;
      }
      button.primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .preview {
        margin-top: 20px;
      }
      .preview img {
        max-width: 300px;
        max-height: 300px;
        border: 1px solid #ddd;
      }
      .items-list {
        margin-top: 40px;
      }
      .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .item-card {
        border: 1px solid #ddd;
        padding: 10px;
        background: #fafafa;
      }
      .item-card img {
        width: 100%;
        height: 200px;
        object-fit: contain;
        background: #fff;
        margin-bottom: 10px;
      }
      .item-card h3 {
        font-size: 14px;
        margin-bottom: 4px;
      }
      .item-card p {
        font-size: 12px;
        color: #666;
        margin-bottom: 2px;
      }
      .item-card button {
        width: 100%;
        margin-top: 10px;
        padding: 8px;
        background: #fee;
        border: 1px solid #fcc;
        color: #c00;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>My Closet</h1>
      <div>
        <span class="user-info" id="user-email"></span>
        <button onclick="shareCloset()">Share Closet</button>
        <button onclick="window.location.href='/'">View Generator</button>
        <button onclick="logout()">Logout</button>
      </div>
    </header>
    
    <div class="container">
      <div id="upload-form">
        <div class="upload-area" id="drop-zone">
          <h2>Upload a clothing item</h2>
          <p>Drag & drop an image or click to browse</p>
          <input type="file" id="file-input" accept="image/*" />
        </div>
        
        <div class="preview" id="preview" style="display: none;">
          <img id="preview-img" />
        </div>
        
        <div class="form-group">
          <label>Item Name</label>
          <input type="text" id="item-name" placeholder="e.g., Black Polo Tee" />
        </div>
        
        <div class="form-group">
          <label>Category</label>
          <select id="category">
            <option value="">Select category...</option>
            <option value="top">Top (T-shirts, Polos)</option>
            <option value="top-overshirt">Overshirt/Midlayer (Shirts, Hoodies, Sweaters)</option>
            <option value="outerwear">Outerwear (Jackets, Coats)</option>
            <option value="bottom">Bottom (Pants, Shorts)</option>
            <option value="shoes">Shoes</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Colors</label>
          <div class="checkbox-group">
            <label><input type="checkbox" value="black" /> Black</label>
            <label><input type="checkbox" value="white" /> White</label>
            <label><input type="checkbox" value="navy" /> Navy</label>
            <label><input type="checkbox" value="grey" /> Grey</label>
            <label><input type="checkbox" value="beige" /> Beige</label>
            <label><input type="checkbox" value="brown" /> Brown</label>
            <label><input type="checkbox" value="green" /> Green</label>
            <label><input type="checkbox" value="blue" /> Blue</label>
            <label><input type="checkbox" value="red" /> Red</label>
          </div>
        </div>
        
        <div class="form-group">
          <label>Style</label>
          <div class="checkbox-group">
            <label><input type="checkbox" value="casual" /> Casual</label>
            <label><input type="checkbox" value="formal" /> Formal</label>
            <label><input type="checkbox" value="street" /> Street</label>
            <label><input type="checkbox" value="sport" /> Sport</label>
          </div>
        </div>
        
        <button class="primary" id="upload-btn" disabled>Upload Item</button>
      </div>
      
      <div class="items-list">
        <h2>Your Closet (<span id="item-count">0</span> items)</h2>
        <div class="loading" id="loading">Loading your items...</div>
        <div class="items-grid" id="items-grid"></div>
      </div>
    </div>
    
    <script type="module">
      import { initFirebase } from './firebase-config.js';
      import { signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      import { 
        doc, 
        getDoc,
        updateDoc,
        arrayUnion,
        arrayRemove 
      } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { 
        ref, 
        uploadBytes,
        getDownloadURL,
        deleteObject 
      } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
      
      let auth, db, storage, currentUser;
      let selectedFile = null;
      
      // Initialize Firebase
      (async () => {
        const firebase = await initFirebase();
        auth = firebase.auth;
        db = firebase.db;
        storage = firebase.storage;
        
        auth.onAuthStateChanged(async (user) => {
          if (user) {
            currentUser = user;
            document.getElementById('user-email').textContent = user.email;
            await loadUserItems();
          } else {
            window.location.href = '/auth.html';
          }
        });
      })();
      
      window.logout = async () => {
        await signOut(auth);
        window.location.href = '/auth.html';
      };
      
      window.shareCloset = () => {
        if (!currentUser || !currentUser.displayName) return;
        const shareUrl = `${window.location.origin}/?user=${currentUser.displayName}`;
        
        // Try to copy to clipboard
        if (navigator.clipboard) {
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert(`Share link copied to clipboard!\n\n${shareUrl}\n\nAnyone with this link can view your closet.`);
          }).catch(() => {
            prompt('Share this link with others:', shareUrl);
          });
        } else {
          prompt('Share this link with others:', shareUrl);
        }
      };
      
      // File upload handling
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      const preview = document.getElementById('preview');
      const previewImg = document.getElementById('preview-img');
      const uploadBtn = document.getElementById('upload-btn');
      
      dropZone.addEventListener('click', () => fileInput.click());
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
      });
      
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
      });
      
      function handleFile(file) {
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }
        
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          preview.style.display = 'block';
          uploadBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      }
      
      // Upload item
      uploadBtn.addEventListener('click', async () => {
        if (!selectedFile || !currentUser) return;
        
        const name = document.getElementById('item-name').value || selectedFile.name;
        const category = document.getElementById('category').value;
        
        if (!category) {
          alert('Please select a category');
          return;
        }
        
        const colors = Array.from(document.querySelectorAll('input[type="checkbox"][value]:checked'))
          .filter(cb => ['black', 'white', 'navy', 'grey', 'beige', 'brown', 'green', 'blue', 'red'].includes(cb.value))
          .map(cb => cb.value);
        
        const styles = Array.from(document.querySelectorAll('input[type="checkbox"][value]:checked'))
          .filter(cb => ['casual', 'formal', 'street', 'sport'].includes(cb.value))
          .map(cb => cb.value);
        
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        
        try {
          // Upload image to Firebase Storage
          const fileExt = selectedFile.name.split('.').pop();
          const fileName = `${currentUser.uid}/${Date.now()}.${fileExt}`;
          const storageRef = ref(storage, `clothes/${fileName}`);
          
          await uploadBytes(storageRef, selectedFile);
          const downloadURL = await getDownloadURL(storageRef);
          
          // Create item object
          const item = {
            id: Date.now().toString(),
            name: name,
            category: category === 'top' ? 'top' : category === 'top-overshirt' ? 'top' : category,
            topLayer: category === 'top' ? 'base' : category === 'top-overshirt' ? 'overshirt' : null,
            file: downloadURL,
            storagePath: fileName,
            colorHints: colors,
            styleHints: styles,
            uploadedAt: new Date().toISOString()
          };
          
          // Add to Firestore
          const userRef = doc(db, 'users', currentUser.uid);
          await updateDoc(userRef, {
            items: arrayUnion(item)
          });
          
          alert('Item uploaded successfully!');
          
          // Reset form
          selectedFile = null;
          fileInput.value = '';
          preview.style.display = 'none';
          document.getElementById('item-name').value = '';
          document.getElementById('category').value = '';
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          uploadBtn.textContent = 'Upload Item';
          uploadBtn.disabled = true;
          
          // Reload items
          await loadUserItems();
        } catch (error) {
          console.error('Upload error:', error);
          alert('Error uploading item: ' + error.message);
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'Upload Item';
        }
      });
      
      // Load user items
      async function loadUserItems() {
        const loading = document.getElementById('loading');
        const grid = document.getElementById('items-grid');
        const count = document.getElementById('item-count');
        
        loading.style.display = 'block';
        grid.innerHTML = '';
        
        try {
          const userRef = doc(db, 'users', currentUser.uid);
          const userDoc = await getDoc(userRef);
          
          if (userDoc.exists()) {
            const items = userDoc.data().items || [];
            count.textContent = items.length;
            
            if (items.length === 0) {
              loading.textContent = 'No items yet. Upload your first item!';
            } else {
              loading.style.display = 'none';
              items.forEach(item => {
                const card = createItemCard(item);
                grid.appendChild(card);
              });
            }
          }
        } catch (error) {
          console.error('Error loading items:', error);
          loading.textContent = 'Error loading items';
        }
      }
      
      function createItemCard(item) {
        const card = document.createElement('div');
        card.className = 'item-card';
        
        const img = document.createElement('img');
        img.src = item.file;
        img.alt = item.name;
        
        const h3 = document.createElement('h3');
        h3.textContent = item.name;
        
        const category = document.createElement('p');
        category.textContent = `Category: ${item.category}`;
        
        const colors = document.createElement('p');
        colors.textContent = `Colors: ${item.colorHints.join(', ') || 'none'}`;
        
        const styles = document.createElement('p');
        styles.textContent = `Style: ${item.styleHints.join(', ') || 'none'}`;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteItem(item);
        
        card.appendChild(img);
        card.appendChild(h3);
        card.appendChild(category);
        card.appendChild(colors);
        card.appendChild(styles);
        card.appendChild(deleteBtn);
        
        return card;
      }
      
      async function deleteItem(item) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        try {
          // Delete from Storage
          const storageRef = ref(storage, `clothes/${item.storagePath}`);
          await deleteObject(storageRef);
          
          // Remove from Firestore
          const userRef = doc(db, 'users', currentUser.uid);
          await updateDoc(userRef, {
            items: arrayRemove(item)
          });
          
          await loadUserItems();
        } catch (error) {
          console.error('Delete error:', error);
          alert('Error deleting item: ' + error.message);
        }
      }
    </script>
  </body>
</html>

